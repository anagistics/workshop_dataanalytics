---
title: "Eine kleine Einführung in die Datenanalyse mit R"
author: "Dr.-Ing. Andreas Cardeneo"
date: "Mai - Juni 2021"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

# Einführung

Diese kleine Einführung in R orientiert sich am bekannten Ablauf von Datenprojekten:

```{r img-process, echo=FALSE, fig.align = 'center', out.width = "80%", fig.cap = "Quelle: R for Data Science"}

knitr::include_graphics("./img/data-science-explore.png")
```

Zu jedem der 6 Hauptschritte gibt es ein Kapitel mit Codebeispielen zu typischen Arbeitsschritten. In den eigenen Projekten können diese Beispiele als Vorlage dienen. Grundsätzlich empfehle ich, in einem eigenen Projekt zu arbeiten und dort eine *R Markdown*-Datei anzulegen. Ein kurzes 1minütiges Video zu R Markdown findet sich unter [https://vimeo.com/178485416](https://vimeo.com/178485416).

## Projekt und Notebook anlegen

In dieser Einführung gehe ich davon aus, dass Sie mit *RStudio Cloud* arbeiten - RStudio als Desktop-Anwendung auf dem eigenen Rechner funktioniert aber ebenso. Ein neues Projekt erreicht man, indem man in RStudio-Cloud zunächst mittels `New Project` ein neues Projekt anlegt (in RStudio Desktop kann man dies über `File | New Project...` erreichen). Wechselt man in dieses Projekt, legt man über `File | New File... | R Notebook` eine sog. *Notebook*-Datei an. In diesem Format kann man einerseits Text schreiben und über die Auszeichnungssprache *Markdown* formatieren und andererseits Code-Abschnitte einfügen und die Ausgaben der Ausführung in das Dokument aufnehmen. Das initial von RStudio angelegte Dokument enthält direkt eine kleine Anleitung und Übersicht über die Möglichkeiten im Anschluss an einen Dokumentkopf zwischen zwei `---`-Zeilen. Ich empfehle, diese Kurzanleitung einmal durchzulesen und nachzuvollziehen und dann zu löschen.

Über die im Einführunstext auch beschriebene Tastenkombination `Alt + Strg + I` wird ein neuer Code-Abschnitt (*Chunk*) für R in das Dokument eingefügt. Code, der innerhalb eines solchen Abschnitts eingefügt wird, kann direkt über den kleinen grünen Pfeil in der rechten oberen Ecke des Chunks ausgeführt werden. Das `Run`-Menü im Dokumentenfenster enthält zahlreiche Befehle für die Ausführung von Code-Chunks.

```{r rs-run-chunks, echo=FALSE, fig.align = 'center', out.width = "80%", fig.cap = "Kommandos zur Code-Ausführung"}

knitr::include_graphics("./img/rstudio-run-commands.png")
```

Aus einem Notebook erzeugt RStudio ein veröffentlichbares Dokument in wählbaren Formaten. Dieser Vorgang wird *knitting* genannt, weil hier verschiedene Quellen (Text, Code, ggf. noch `HTML` und `CSS`) zu einem Ergebnis *verstrickt* werden.

```{r rs-knit, echo=FALSE, fig.align = 'center', out.width = "80%", fig.cap = "Ausgabe des Dokuments in verschiedenen Formaten"}

knitr::include_graphics("./img/rstudio-knit-commands.png")
```

## Pakete

Wie andere Sprachen auch, bietet R eine Vielzahl von Funktionen (und Daten) in Paketen (in anderen Sprachen spricht man von Bibliotheken oder Modulen). Diese Pakete müssen zunächst installiert werden und werden dann nach Bedarf über die Funktion `library` geladen und verfügbar gemacht. Die häufigste Quelle von Paketen ist das [`CRAN`](https://cran.r-project.org/) (*Comprehensive R Archive Network*). Diese Quelle ist in RStudio für den Menüpunkt `Tools | Install Packages...` voreingestellt und auch die Funktion `install.packages` sucht Pakete standardmäßig dort. Der folgende Code lädt bspw. das verbreitete Paket `tidyverse`:

```{r}
library(tidyverse)
```

Wie man an der Ausgabe sieht, handelt es sich bei `tidyverse` eigentlich um ein Paket von Paketen - die Pakete `ggplot2`, `dplyr`, `purrr` usw. könnten auch einzeln per `library`-Aufruf geladen werden. Aber man benötigt häufig Funktionen aus dieser Paketfamilie und damit ist der obige Aufruf einfacher.

## Hilfe

Sowohl die Basisinstallation von R als auch die Pakete bieten eine Hilfe an, die in RStudio im `Help`-Panel angezeigt wird. Benötigt man für ein Kommando `cmd` eine Hilfe, kann man in der Konsole (`Console`-Panel) über `?cmd` eine Hilfeseite aufrufen. Zugegebenermaßen ist diese Hilfeseite nicht immer ganz einfach zu verstehen, weil sie doch recht kompakt ist und gerade komplexere Kommandos eher kurz abgehandelt werden. Mit `??cmd` kann die Hilfe zu Einträgen zu `cmd` durchsucht werden.

Im `Help`-Menü gibt es weiterhin Hilfe zu den Möglichkeiten von Markdown unter dem Eintrag `Markdown Quick Reference`. Über das Untermenü `Cheatsheets` können weitere PDF-Dateien mit kompakten Befehlsübersichten und -erklärungen heruntergeladen werden.

# Daten laden

R bietet viele Pakete und Funktionen, um Daten aus den verschiedensten Quellen zu laden, bspw.  SQL-Datenbanken, SAS-Dateien, Excel XLSX und XLS-Dateien, CSV, JSON, HDF5, Apache Arrow uvm.

Eine XLSX-Datei mit dem Namen `Telco_customer_churn.xlsx` im Ordner `data` lässt sich mit der Funktion `read_xlsx` aus dem `readxl`-Paket laden:

```{r}
library(readxl)

churn <- read_xlsx("data/Telco_customer_churn.xlsx")
```

Im Code oben werden die Daten über den Zuweisungsoperator `<-` der Variable `churn` zugewiesen. Es ist in R nicht nötig, Variablen zu deklarieren und explizit einen Datentyp anzugeben. Über die Funktion `class` erhält man eine Aufzählung der von einer Variablen geerbten Klassen (in dieser Einführung gehe ich nicht auf die verschiedenen Objektsysteme von R ein).

```{r}
class(churn)
```

Das Ergebnis listet u.a. `data.frame` auf: Dies ist eine Datenstruktur für Datentabellen, d.h. eine Liste von Spalten mit Werten eines Datentyps. Die Funktion `names` liefert die Namen der Spalten der Datentabelle:

```{r}
names(churn)
```

Auf die einzelnen Spalten kann man mit dem `$`-Operator zugreifen. Die Funktion `head` beschränkt die Ausgabe auf die ersten paar Elemente:
```{r}
head(churn$CustomerID)
```



# Datensätze verbinden

# Daten sichten, sortieren und filtern

Um sich einen ersten Überblick über Daten zu verschaffen kann man die Befehle `summary` und `glimpse` verwenden:
```{r}
summary(churn)
```

`summary` lässt sich auch sinnvoll auf eine einzelne Spalte anwenden, bspw.:
```{r}
summary(churn$`Monthly Charges`)
```


```{r}
glimpse(churn)
```
Für das Sichten, Sortieren, Filtern und weitere Operationen gibt es in R verschiedene Möglichkeiten und grundsätzlich sind diese Operationen natürlich auch ohne Zusatzpakete möglich. Allerdings empfehle ich hier aus Gründen der Lesbarkeit und der Kombinierbarkeit mit weiteren Operationen (s. unten) die Funktionen aus dem `dplyr`-Paket bzw. allgemein aus `tidyverse`: Auswahl von Spalten mittels `select` analog zu SQL, Sortieren mittels `arrange` und Filtern mit der Funktion `filter`. Zudem bietet es sich an, den *Pipe*-Operator `%>%` (definiert im Paket `magrittr`) zu verwenden. Dieser Operator ist im Grunde zwar nur *syntactic sugar*, sorgt aber für eine sehr klare Struktur von Datenverarbeitungsschritten.[^1]

[^1]: `%>%` funktioniert folgendermaßen: Anstelle von `meine_funktion(a,b)` schreibt man `a %>% meine_funktion(b)`. Damit erreicht man eine bessere Lesbarkeit: Anstelle von `schritt_2(schritt_1(daten))` schreibt man `daten %>% schritt_1 %>% schritt_2` und dokumentiert quasi automatisch den Ablauf mit der Syntax. Ab R v4.1 gibt es nativ in der Sprache den Pipe-Operator `|>`, der vergleichbar mit dem Pipe-Operator `|` der C++ 20 Ranges ist. 

```{r echo=TRUE}
selection <- churn %>% 
  filter(`Payment Method` == "Electronic check") %>% 
  arrange(`Tenure Months`) %>% 
  select(City, Gender, `Tenure Months`)
```

Im obigen Statement wird das Ergebnis der Filterung, Sortierung und Spaltenauswahl der neuen Variablen `selection` zugewiesen. Mit dieser kann dann ggf. weitergearbeitet werden.

Möchte man in absteigender Reihenfolge sortieren, setzt man das entsprechende Argument in `desc(...)` ein:
```{r}
churn %>% 
  arrange(desc(`Total Charges`), `Zip Code`) %>% 
  select(`Total Charges`, `Zip Code`) %>% 
  head(10)
```

Filterkriterien sind logische Ausdrücke und können die bekannten Operatoren `==`, `!=`, `<`, `>`, `<=` und `>=` sowie `%in%` umfassen und mit `&` bzw. `|` und Klammerung kombiniert werden.

# Daten transformieren

Möchte man neue Spalten hinzufügen, ändern oder löschen verwendet man die Funktion `mutate`:
```{r}
crp <- churn %>% mutate(REGION = floor(`Zip Code` / 1000), 
                        Country = NULL,
                        `Phone Service` = if_else(`Phone Service` == "Yes", 1, 0)) %>% 
  select(CustomerID, REGION, `Phone Service`) %>% 
  head(10)
```

Das obige Statement führt drei Transformationen durch:

1. Eine neue Spalte `REGION` wird angelegt, die grob aus der Postleitzahl eine Region ableitet,
1. die Spalte `Country` wird gelöscht (weil dort immer derselbe Wert *United States* drin steht),
1. die Spalte `Phone Service` wird umgewandelt von einer *Yes/No*-Codierung der Kategorie in eine numerische 1/0-Codierung. Damit kann dann später leichter gerechnet werden. Hilfreich ist hierbei die `if_else`-Funktion, die (ähnlich wie in Excel) eine if-else-Verzweigung als Funktion anbietet.

# Daten aggregieren

# Visualisieren

# Modellierung

---
# Online R lernen

Hier eine Reihe von Videos bzw. Webseiten, die beim Erlernen von R hilfreich sein können:

`r emo::ji("backhand index pointing right")` [Datenanalyse mit R, HS Kaiserslautern](https://www.youtube.com/watch?v=eNl7m9iJwSQ)

`r emo::ji("backhand index pointing right")` Cheatsheets und Primer in RStudio Cloud

`r emo::ji("backhand index pointing right")` [YouTube Kanal *Statistik am PC*](https://www.youtube.com/c/StatistikamPC_BjoernWalther/playlists)

`r emo::ji("backhand index pointing right")` [Crashkurs *Programmieren in R*](https://datentaeter.de/crashkurs-programmieren-in-r-fuer-journalismus-rstudio-coden-datenjournalismus-installation-tutorial/) 

`r emo::ji("backhand index pointing right")` [Datenanalyse in R  1](http://christopherharms.de/stuff/r-workshop/R-Workshop_UniBonn_Tag1.pdf)

`r emo::ji("backhand index pointing right")` [Datenanalyse in R  2](http://christopherharms.de/stuff/r-workshop/R-Workshop_UniBonn_Tag2.pdf)
