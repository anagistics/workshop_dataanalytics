---
title: "Workshop Datenanalyse"
subtitle: "mit einem Schwerpunkt auf Versicherungsunternehmen"
author: "Dr.-Ing. Andreas Cardeneo"
institute: "Data Scientist bei Allianz Lebensversicherungs-AG"
email: "andreas.cardeneo@lehre.dhbw-stuttgart.de"
date: "2020-01-13 (Version vom: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false

--- 
class: inverse, center, middle

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)

library(emo)
library(kableExtra)
library(ggalluvial)
```

# Datenanalyse in Versicherungsunternehmen?

Wir sammeln mal ein paar Aufgaben, die dazu passen.


---
# Der Prozess der Datenanalyse

1. Die richtigen Fragen finden: Was möchte ich eigentlich wissen?
2. Die eigentliche Datenanalyse:

   ![Datenanalyseprozess](./img/data-science-explore.png)

Quelle: [*R for Data Science*](https://r4ds.had.co.nz/explore-intro.html)

Der Punkt *Model* in obiger Graphik bezieht sich auf Datenanalyse im Kontext von *Data Science*, wenn es darum geht, aus den Daten deskriptive oder prädiktive Modelle abzuleiten.

Auf den folgenden Seiten werden die einzelnen Schritte etwas genauer erklärt.


---
# Import

* Dieser Schritt heißt oft auch *Extrakt*, weil es um die Extraktion von Daten aus Quellen geht.
* 

`r emo::ji("question")` Woher beziehen wir eigentlich Daten?


---
# Datenquellen in VU (1)

* Datenbanken - strukturierte Daten
  * OLTP<sup>1</sup>-Systeme z.B. für die Vertragsverwaltung, Zahlvorgänge, Finanzbuchungen
  * OLAP<sup>2</sup>-Systeme für Reporting (Berichtswesen): Nilden die technische Grundlage für  BI<sup>3</sup>-Systeme
  
Meistens werden *relationale Datenbanken* verwendet, auf die mittels `SQL` zugegriffen wird.

.footnote[
[1] *OLTP* - Online Transaction Processing, IT-Systeme, die eine hohe Zahl vergleichsweise kleiner Datenverarbeitungsschritte ausführen, z.B. Datensatzänderungen, Neuanlage von Datensätzen.

[2] *OLAP* - Online Analytical Processing, (interaktive) IT-Systeme für Analysen auf größeren Datenmengen.

[3] *Business Intelligence* - betriebliche Informationssysteme mit Fokus auf vergangenheitsorientiertes Berichtswesen.
]

---
# Datenquellen in VU (2)

* Verwaltungssysteme für unstrukturierte Daten
  * Dokumentenarchive bspw. für Briefe von/an Kunden, Rechtsanwälte, Gutachter, Vertreter usw.
  * Archive für Bilddaten, bspw. Dokumentation von Schadensfällen
  
Diese Verwaltungssysteme lassen sich üblicherweise nicht in vergleichsweise standardisierter Form abfragen wie relationale Datenbanken und die Inhalte müssen erst weiter verarbeitet werden, bspw. mittels OCR<sup>1</sup>. 

.footnote[
[1] *OCR* - Optical Character Recognition, maschinelle Erkennung von (Schrift-)Zeichen, zumeist inkl. Erkennung des Kontexts (Anschrift, Anrede, Betreff, Brieftext usw.).
]

---
# Datenquellen in VU (3)

* Anwendungsdaten
    * insbesondere Office
         * insbesondere `Excel`
  
  Hier liegen die Daten meistens in Form von Dateien in einem Verzeichnis vor. Möchte man die Daten analysieren, müssen diese erst aus den Dokumenten extrahiert oder aus den Anwendungen heraus exportiert werden. Typischer Fall: `CSV`-Dateien für tabellarische Daten.
  
* Technische Protokolle

  Die meisten *Backend*-Systeme wie bspw. *Webserver* protokollieren Zugriffe in Protokolldateien (*Log*-Dateien). Diese Dateien werden normalerweise rollierend überschrieben, bieten aber auf technischer Ebene detaillierte Informationen und insbesondere Zeitstempel. 

  Die Protokolle werden in ähnlicher oder gleicher Form oftmals auch in Datenbanktabellen geschrieben.
        
---
# Datenquellen in VU (4)

* APIs<sup>1</sup>
  
  Modernere IT-Architekturen (heute vielfach [Microservice-Architekturen](https://www.ionos.de/digitalguide/websites/web-entwicklung/microservice-architecture-so-funktionieren-microservices/) definieren technische Schnittstellen, damit die anbietenden Systeme auf relative einfache Weise von außen angesteuert werden können. APIs ermöglichen insbesondere die Abfrage von Zuständen und Daten. Beispiele sind Finanzdaten, Wetterdaten. 

**Beispiel:** Anbieter *Quandl* liefert u.a. Finanzdaten: [https://www.quandl.com/api/v3/datasets/FSE/ALV_X.json?api_key=XXXXXX](https://www.quandl.com/api/v3/datasets/FSE/ALV_X.json)

Für alle oben genannten Datenquellen gilt: Die meisten davon werden überall in Unternehmen genutzt und sind nicht spezifisch für die Versicherungsbranche.

**Was könnte für die Versicherungsbranche besonders sein?**


.footnote[
*API* - Application Programming Interface, technische Schnittstelle zu einem IT-System, um dieses durch andere Programme zu nutzen, d.h. durch die API wird ein IT-System maschinell nutzbar.
]

---
# Besonderheiten von Datenquellen in VU

Versicherungen sind oftmals sehr langlebige Produkte:
* Verträge (bspw. für Lebensversicherungen) laufen über mehrere Jahrzehnte

    `r emo::ji("question")` Wie haben sich IT-Systeme in der Zeit geändert?
    
  &rarr; Wir haben es oftmals mit sehr verschiedenen Technologien zu tun, die *integriert* werden müssen.
  
  &rarr; Betrifft nicht nur Hardware, sondern auch Software z.B. Umlaute in alten Datenbeständen (7 Bit ASCII, kein UTF).
  
  &rarr; Datenstrukturen (bspw. Tabellenschemata) verändern sich über die Zeit wg. wandelnder Anforderungen.


---
# Datenanalyse per Code 

* In vielen Unternehmen wird für die Datenanalyse GUI-basierte Software wie bspw. *PowerBI*, *Tableau*, *Microstrategy*,...<sup>1</sup> verwendet.
* Wird die Datenanalyse per *Code* ausgeführt, also programmmiert, gibt es folgende Vorteile:
    * die *Reproduzierbarkeit* der Ergebnisse ist besser
    * erleichterte *Kollaboration* mittels Versionsverwaltung 
    * weit größere Möglichkeiten der Datentransformation durch *Programmierbarkeit*
    * [Artikel zu Data Science und Programmierung](https://blog.dominodatalab.com/data-scientist-programmer-mutually-exclusive/)


`r emo::ji("backhand index pointing right")` [Crashkurs *Programmieren in R*](https://datentaeter.de/crashkurs-programmieren-in-r-fuer-journalismus-rstudio-coden-datenjournalismus-installation-tutorial/) 

`r emo::ji("backhand index pointing right")` [Datenanalyse in R  1](http://christopherharms.de/stuff/r-workshop/R-Workshop_UniBonn_Tag1.pdf)

`r emo::ji("backhand index pointing right")` [Datenanalyse in R  2](http://christopherharms.de/stuff/r-workshop/R-Workshop_UniBonn_Tag2.pdf)


    
.footnote[
[1] Einige dieser Anwendungen sind auch in gewissem Umfang programmierbar.
]

---
# Nützliche Kenntnisse für die Datenanalyse per Code

* SQL
* XMLPath
* reguläre Ausdrücke
* Web Scraping
* Visualisierung


---
# Datenschutz
	
* *Datenschutzgrundverordnung* (DGSVO) seit 25. Mai 2018 wirksam
* Schutz personenbezogener Daten in der Europäischen Union

`r emo::ji("question")` Was sind *personenbezogene Daten*?

Nach [Art. 4 (1) der DSGVO](https://dejure.org/gesetze/DSGVO/4.html)
> personenbezogene Daten [sind] alle Informationen, die sich auf eine identifizierte oder identifizierbare 
> natürliche Person (im Folgenden "betroffene Person") beziehen; als identifizierbar wird eine natürliche
> Person angesehen, die direkt oder indirekt, insbesondere mittels Zuordnung zu einer Kennung wie einem
> Namen, zu einer Kennnummer, zu Standortdaten, zu einer Online-Kennung oder zu einem oder mehreren
> besonderen Merkmalen, die Ausdruck der physischen, physiologischen, genetischen, psychischen, 
> wirtschaftlichen, kulturellen oder sozialen Identität dieser natürlichen Person sind, identifiziert werden
> kann.

---
# Umgang mit personenbezogenen Daten

`r emo::ji("question")` Enthalten die Datenquellen personenbezogene Daten?

`r emo::ji("question")` Werden für die Datenanalyse wirklich personenbezogene Daten (*pbDaten*) benötigt?

* Daten können *anonymisiert* oder *pseudonymisiert* werden:
    * **Anonymisierung**: pbDaten werden unumkehrbar verändert, eine Zuordnung von Merkmalsausprägungen zu Personen ist nicht mehr herstellbar
    * **Pseudonymisierung**: Erklärung nach [Art. 4 DSGVO](https://dsgvo-gesetz.de/art-4-dsgvo/):
    > die Verarbeitung personenbezogener Daten in einer Weise, dass die personenbezogenen Daten ohne Hinzuziehung zusätzlicher Informationen nicht mehr einer spezifischen betroffenen Person zugeordnet werden können, sofern diese zusätzlichen Informationen gesondert aufbewahrt werden und technischen und organisatorischen Maßnahmen unterliegen, die gewährleisten, dass die personenbezogenen Daten nicht einer identifizierten oder identifizierbaren natürlichen Person zugewiesen werden;

---
# Typische Transformationen personenbezogener Daten

* Entfernen von Namen (für Analysezwecke werden diese typischerweise nicht benötigt)
* Geburtsdatum durch Alter ersetzen
* Telefonnummern verkürzen (Vorwahl ausreichend?)
* IBAN: Auf Bankleitzahl verkürzen
* IP-Adresse: Ohnehin nicht aussagekräftig -- Geolokation stattdessen?
* Adresse verkürzen, bspw. auf Postleitzahl
* Analysen mit regionalem Bezug nicht auf kleine Regionen anwenden
 
---
# Qualitätssicherung in der Datenanalyse (1)

* Versionierung

---
# Qualitätssicherung in der Datenanalyse (2)

* data lineage

---
# Qualitätssicherung in der Datenanalyse (3)

* Upload-Timestamp
* Fingerprints


---
# Qualitätssicherung in der Datenanalyse (4)

* technischer Schlüssel


---
# Schritt: Datenquellen lesen

* Datenformat (Trennzeichen, Quoting...)
* Encoding 


---
# Umgang mit sehr großen Datenmengen

* Datenumfang manchmal größer als verfügbare Rechneressourcen (Speicher)
* Einlesen von Teilmengen
    * Deterministisches Einlesen 
    * Zufälliges Einlesen
```{r}
# Beispiel in R
```
    * 
* Verteilte Verarbeitung
    * Erfordert geeignete technische Infrastruktur
        * Cluster von Rechnern
        * Software für die verteilte Speicherung und Verarbeitung
            * Hadoop (HDFS Dateisystem)
            * Spark, Pig, ...


---
# Schritt: Daten verstehen 

* Variablen und Beobachtungen
* Validieren
* Datentypen
* Plotten 
* QS: Magic Numbers

---
# Die allgemeine Struktur von Daten

In den Daten einer Datenanalyse können wir immer wieder die gleiche Struktur erkennen:

* Die Daten bestehen aus einer Menge von gleichartigen *Datensätzen*, auch *Instanzen* oder *Objekte* genannt,
* wobei die einzelnen Datensätze durch bestimmte *Eigenschaften* oder *Merkmale* oder *Variablen* beschrieben werden 
* und diese Merkmale pro Instanz bestimmte *Ausprägungen* haben, die auch *Beobachtungen* genannt werden<sup>1</sup>.

`r emo::ji("backhand index pointing right")` Unternehmensdaten können meistens in Tabellenform extrahiert werden. Die Zeilen entsprechen dann meistens den Instanzen und die Spalten(namen) den Variablen. Die Werte in den Tabellenzellen entsprechen den Beobachtungen. 

.footnote[
[1] Manchmal wird auch die Gesamtheit der Ausprägungen zu einer Instanz Beobachtung genannt. Man spricht dann auch von einem *Datenpunkt* in einem (mehrdimensionalem) Raum.
]


---
# Typen von Variablen

* Man unterscheidet zwischen verschiedenen Typen von Variablen
  * *kategoriell*
  * *quantitativ*
    * Skalenniveau
    * 



---
# Unstrukturierte Daten

Unter *unstrukturierte Daten* versteht man oft Texte, Bilder, Videos oder Audiodaten. 
  * In technischer Hinsicht sind die Daten strukturiert, weil sie in einem definierten Format vorliegen.
  * Für die Analyse ist man aber eher *Inhalt* der Daten interessiert. 
  * 

---
# Ausreißeranalyse



---
# Fehlende Werte



---
# Besondere Werte


---
# Datenanalyse

* Boxplots, violin plots
* Histogramme
* Scatterplots, 
* Korrelation
* Tests auf statistische Unabhängigkeit
* 

---
 


---
# Visualisierung: Histogramm


---
# Visualisierung: Boxplot


---
# 

---
# Visualisierung: Alluvial-Diagramme

* ähnlich zu *Parallelkoordinaten* aber für kategorielle Variablen
* `R`-Paket: `ggalluvial`

```{r echo = FALSE}
ggplot(as.data.frame(Titanic),
       aes(y = Freq,
           axis1 = Sex, axis2 = Class, axis3 = Survived)) +
  geom_alluvium(aes(fill = Class),
                width = 0, knot.pos = 0, reverse = FALSE) +
  guides(fill = FALSE) +
  geom_stratum(width = 1/8, reverse = FALSE) +
  geom_text(stat = "stratum", infer.label = TRUE, reverse = FALSE) +
  scale_x_continuous(breaks = 1:3, labels = c("Sex", "Class", "Survived")) +
  ggtitle("Titanic survival by class and sex")

```

---
# Modellierung (1)

`r emo::ji("question")` Was ist ein *Modell*?
> Ein Modell ist ein vereinfachtes Abbild der Wirklichkeit. ([Wikipedia](https://de.wikipedia.org/wiki/Modell))

`r emo::ji("star")` Mit einem Modell versucht man in kompakter Form die Aussage der Daten in anwendbarer Form bereitzustellen.   

* Abstraktion der Realität zu einem bestimmten Zweck. In der Datenanalyse zumeist um Sachverhalte
    * zu verstehen (*deskriptive* Modelle) oder
    * vorherzusagen (*prädiktive* Modelle)

> All models are wrong [, some are useful] ([George Box, 1976](https://en.wikipedia.org/wiki/All_models_are_wrong))

---
# Modellierung (2)

Typische Modelle:
* **Prognose**: Vorhersage zukünftiger Werte von Zeitreihen
* **Segmentierung**: Einteilung von Beobachtungen in Gruppen (*Segmente*), bspw. 
von Kunden in Zielgruppen für Marketingkampagnen
* **Regression**:  Quantifizierung des (statistischen) Zusammenhangs zwischen beobachteten Ausprägungen und einer Zielgrösse 

---
# Beispiel: Daten laden 

[*Telco custumer churn data set* von IBM](https://developer.ibm.com/patterns/data-analysis-model-building-and-deploying-with-wml/)

Der folgende Code lädt die Daten von der Webseite:

```{r load_telco_data, message=FALSE}
library(tidyverse)


url <- "https://raw.githubusercontent.com/IBM/telco-customer-churn-on-icp4d/master/data/Telco-Customer-Churn.csv"

telco_data <- read_csv(url)
```

Liste der Spalten:
```{r}
names(telco_data) %>% kable(., format = "html")
```


---
# Beispiel: Übersicht über die Daten

Zufällige Auswahl der ersten 5 Spalten von 10 Datensätzen.

```{r show_telco_data}
telco_data %>% select(one_of(names(.)[1:5])) %>% sample_n(10) %>% 
  kable(., format = "html")
```


---
background-image: url(https://upload.wikimedia.org/wikipedia/commons/b/be/Sharingan_triple.svg)

???

Image credit: [Wikimedia Commons](https://commons.wikimedia.org/wiki/File:Sharingan_triple.svg)

---
class: cen ter, middle

# xaringan

### /ʃaː.'riŋ.ɡan/

---
class: inverse, center, middle

# Get Started

---

# Hello World

Install the **xaringan** package from [Github](https://github.com/yihui/xaringan):

```{r eval=FALSE, tidy=FALSE}
devtools::install_github("yihui/xaringan")
```

--

You are recommended to use the [RStudio IDE](https://www.rstudio.com/products/rstudio/), but you do not have to.

- Create a new R Markdown document from the menu `File -> New File -> R Markdown -> From Template -> Ninja Presentation`;<sup>1</sup>

--

- Click the `Knit` button to compile it;

--

- or use the [RStudio Addin](https://rstudio.github.io/rstudioaddins/)<sup>2</sup> "Infinite Moon Reader" to live preview the slides (every time you update and save the Rmd document, the slides will be automatically reloaded in RStudio Viewer.

.footnote[
[1] 中文用户请看[这份教程](http://slides.yihui.name/xaringan/zh-CN.html)

[2] See [#2](https://github.com/yihui/xaringan/issues/2) if you do not see the template or addin in RStudio.
]

---
background-image: url(`r xaringan:::karl`)
background-position: 50% 50%
class: center, bottom, inverse

# You only live once!

---

# Hello Ninja

As a presentation ninja, you certainly should not be satisfied by the "Hello World" example. You need to understand more about two things:

1. The [remark.js](https://remarkjs.com) library;

1. The **xaringan** package;

Basically **xaringan** injected the chakra of R Markdown (minus Pandoc) into **remark.js**. The slides are rendered by remark.js in the web browser, and the Markdown source needed by remark.js is generated from R Markdown (**knitr**).

---

# remark.js

You can see an introduction of remark.js from [its homepage](https://remarkjs.com). You should read the [remark.js Wiki](https://github.com/gnab/remark/wiki) at least once to know how to

- create a new slide (Markdown syntax<sup>*</sup> and slide properties);

- format a slide (e.g. text alignment);

- configure the slideshow;

- and use the presentation (keyboard shortcuts).

It is important to be familiar with remark.js before you can understand the options in **xaringan**.

.footnote[[*] It is different with Pandoc's Markdown! It is limited but should be enough for presentation purposes. Come on... You do not need a slide for the Table of Contents! Well, the Markdown support in remark.js [may be improved](https://github.com/gnab/remark/issues/142) in the future.]

---
background-image: url(`r xaringan:::karl`)
background-size: cover
class: center, bottom, inverse

# I was so happy to have discovered remark.js!

---
class: inverse, middle, center

# Using xaringan

---

# xaringan

Provides an R Markdown output format `xaringan::moon_reader` as a wrapper for remark.js, and you can use it in the YAML metadata, e.g.

```yaml
---
title: "A Cool Presentation"
output:
  xaringan::moon_reader:
    yolo: true
    nature:
      autoplay: 30000
---
```

See the help page `?xaringan::moon_reader` for all possible options that you can use.

---

# remark.js vs xaringan

Some differences between using remark.js (left) and using **xaringan** (right):

.pull-left[
1. Start with a boilerplate HTML file;

1. Plain Markdown;

1. Write JavaScript to autoplay slides;

1. Manually configure MathJax;

1. Highlight code with `*`;

1. Edit Markdown source and refresh browser to see updated slides;
]

.pull-right[
1. Start with an R Markdown document;

1. R Markdown (can embed R/other code chunks);

1. Provide an option `autoplay`;

1. MathJax just works;<sup>*</sup>

1. Highlight code with `{{}}`;

1. The RStudio addin "Infinite Moon Reader" automatically refreshes slides on changes;
]

.footnote[[*] Not really. See next page.]

---

# Math Expressions

You can write LaTeX math expressions inside a pair of dollar signs, e.g. &#36;\alpha+\beta$ renders $\alpha+\beta$. You can use the display style with double dollar signs:

```
$$\bar{X}=\frac{1}{n}\sum_{i=1}^nX_i$$
```

$$\bar{X}=\frac{1}{n}\sum_{i=1}^nX_i$$

Limitations:

1. The source code of a LaTeX math expression must be in one line, unless it is inside a pair of double dollar signs, in which case the starting `$$` must appear in the very beginning of a line, followed immediately by a non-space character, and the ending `$$` must be at the end of a line, led by a non-space character;

1. There should not be spaces after the opening `$` or before the closing `$`.

1. Math does not work on the title slide (see [#61](https://github.com/yihui/xaringan/issues/61) for a workaround).

---

# R Code

```{r comment='#'}
# a boring regression
fit = lm(dist ~ 1 + speed, data = cars)
coef(summary(fit))
dojutsu = c('地爆天星', '天照', '加具土命', '神威', '須佐能乎', '無限月読')
grep('天', dojutsu, value = TRUE)
```

---

# R Plots

```{r cars, fig.height=4, dev='svg'}
par(mar = c(4, 4, 1, .1))
plot(cars, pch = 19, col = 'darkgray', las = 1)
abline(fit, lwd = 2)
```

---

# Tables

If you want to generate a table, make sure it is in the HTML format (instead of Markdown or other formats), e.g.,

```{r}
knitr::kable(head(iris), format = 'html')
```

---

# HTML Widgets

I have not thoroughly tested HTML widgets against **xaringan**. Some may work well, and some may not. It is a little tricky.

Similarly, the Shiny mode (`runtime: shiny`) does not work. I might get these issues fixed in the future, but these are not of high priority to me. I never turn my presentation into a Shiny app. When I need to demonstrate more complicated examples, I just launch them separately. It is convenient to share slides with other people when they are plain HTML/JS applications.

See the next page for two HTML widgets.

---

```{r out.width='100%', fig.height=6, eval=require('leaflet')}
library(leaflet)
leaflet() %>% addTiles() %>% setView(-93.65, 42.0285, zoom = 17)
```

---

```{r eval=require('DT'), tidy=FALSE}
DT::datatable(
  head(iris, 10),
  fillContainer = FALSE, options = list(pageLength = 8)
)
```

---

# Some Tips

- When you use the "Infinite Moon Reader" addin in RStudio, your R session will be blocked by default. You can click the red button on the right of the console to stop serving the slides, or use the _daemonized_ mode so that it does not block your R session. To do the latter, you can set the option

    ```r
    options(servr.daemon = TRUE)
    ```
    
    in your current R session, or in `~/.Rprofile` so that it is applied to all future R sessions. I do the latter by myself.
    
    To know more about the web server, see the [**servr**](https://github.com/yihui/servr) package.

--

- Do not forget to try the `yolo` option of `xaringan::moon_reader`.

    ```yaml
    output:
      xaringan::moon_reader:
        yolo: true
    ```

---

# Some Tips

- Slides can be automatically played if you set the `autoplay` option under `nature`, e.g. go to the next slide every 30 seconds in a lightning talk:

    ```yaml
    output:
      xaringan::moon_reader:
        nature:
          autoplay: 30000
    ```

--

- A countdown timer can be added to every page of the slides using the `countdown` option under `nature`, e.g. if you want to spend one minute on every page when you give the talk, you can set:

    ```yaml
    output:
      xaringan::moon_reader:
        nature:
          countdown: 60000
    ```

    Then you will see a timer counting down from `01:00`, to `00:59`, `00:58`, ... When the time is out, the timer will continue but the time turns red.
    
---

# Some Tips

- The title slide is created automatically by **xaringan**, but it is just another remark.js slide added before your other slides.

    The title slide is set to `class: center, middle, inverse, title-slide` by default. You can change the classes applied to the title slide with the `titleSlideClass` option of `nature` (`title-slide` is always applied).

    ```yaml
    output:
      xaringan::moon_reader:
        nature:
          titleSlideClass: [top, left, inverse]
    ```
    
--

- If you'd like to create your own title slide, disable **xaringan**'s title slide with the `seal = FALSE` option of `moon_reader`.

    ```yaml
    output:
      xaringan::moon_reader:
        seal: false
    ```

---

# Some Tips

- There are several ways to build incremental slides. See [this presentation](https://slides.yihui.name/xaringan/incremental.html) for examples.

- The option `highlightLines: true` of `nature` will highlight code lines that start with `*`, or are wrapped in `{{ }}`, or have trailing comments `#<<`;

    ```yaml
    output:
      xaringan::moon_reader:
        nature:
          highlightLines: true
    ```

    See examples on the next page.

---

# Some Tips


.pull-left[
An example using a leading `*`:

    ```r
    if (TRUE) {
    ** message("Very important!")
    }
    ```
Output:
```r
if (TRUE) {
* message("Very important!")
}
```

This is invalid R code, so it is a plain fenced code block that is not executed.
]

.pull-right[
An example using `{{}}`:

````
`r ''````{r tidy=FALSE}
if (TRUE) {
*{{ message("Very important!") }}
}
```
````
Output:
```{r tidy=FALSE}
if (TRUE) {
{{ message("Very important!") }}
}
```

It is valid R code so you can run it. Note that `{{}}` can wrap an R expression of multiple lines.
]

---

# Some Tips

An example of using the trailing comment `#<<` to highlight lines:

````markdown
`r ''````{r tidy=FALSE}
library(ggplot2)
ggplot(mtcars) + 
  aes(mpg, disp) + 
  geom_point() +   #<<
  geom_smooth()    #<<
```
````

Output:

```{r tidy=FALSE, eval=FALSE}
library(ggplot2)
ggplot(mtcars) + 
  aes(mpg, disp) + 
  geom_point() +   #<<
  geom_smooth()    #<<
```

---

# Some Tips

When you enable line-highlighting, you can also use the chunk option `highlight.output` to highlight specific lines of the text output from a code chunk. For example, `highlight.output = TRUE` means highlighting all lines, and `highlight.output = c(1, 3)` means highlighting the first and third line.

````md
`r ''````{r, highlight.output=c(1, 3)}
head(iris)
```
````

```{r, highlight.output=c(1, 3), echo=FALSE}
head(iris)
```

Question: what does `highlight.output = c(TRUE, FALSE)` mean? (Hint: think about R's recycling of vectors)

---

# Some Tips

- To make slides work offline, you need to download a copy of remark.js in advance, because **xaringan** uses the online version by default (see the help page `?xaringan::moon_reader`).

- You can use `xaringan::summon_remark()` to download the latest or a specified version of remark.js. By default, it is downloaded to `libs/remark-latest.min.js`.

- Then change the `chakra` option in YAML to point to this file, e.g.

    ```yaml
    output:
      xaringan::moon_reader:
        chakra: libs/remark-latest.min.js
    ```

- If you used Google fonts in slides (the default theme uses _Yanone Kaffeesatz_, _Droid Serif_, and _Source Code Pro_), they won't work offline unless you download or install them locally. The Heroku app [google-webfonts-helper](https://google-webfonts-helper.herokuapp.com/fonts) can help you download fonts and generate the necessary CSS.

---

# Macros

- remark.js [allows users to define custom macros](https://github.com/yihui/xaringan/issues/80) (JS functions) that can be applied to Markdown text using the syntax `![:macroName arg1, arg2, ...]` or `![:macroName arg1, arg2, ...](this)`. For example, before remark.js initializes the slides, you can define a macro named `scale`:

    ```js
    remark.macros.scale = function (percentage) {
      var url = this;
      return '<img src="' + url + '" style="width: ' + percentage + '" />';
    };
    ```

    Then the Markdown text

    ```markdown
    ![:scale 50%](image.jpg)
    ```

    will be translated to
    
    ```html
    <img src="image.jpg" style="width: 50%" />
    ```

---

# Macros (continued)

- To insert macros in **xaringan** slides, you can use the option `beforeInit` under the option `nature`, e.g.,

    ```yaml
    output:
      xaringan::moon_reader:
        nature:
          beforeInit: "macros.js"
    ```

    You save your remark.js macros in the file `macros.js`.

- The `beforeInit` option can be used to insert arbitrary JS code before `remark.create()`. Inserting macros is just one of its possible applications.

---

# CSS

Among all options in `xaringan::moon_reader`, the most challenging but perhaps also the most rewarding one is `css`, because it allows you to customize the appearance of your slides using any CSS rules or hacks you know.

You can see the default CSS file [here](https://github.com/yihui/xaringan/blob/master/inst/rmarkdown/templates/xaringan/resources/default.css). You can completely replace it with your own CSS files, or define new rules to override the default. See the help page `?xaringan::moon_reader` for more information.

---

# CSS

For example, suppose you want to change the font for code from the default "Source Code Pro" to "Ubuntu Mono". You can create a CSS file named, say, `ubuntu-mono.css`:

```css
@import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

.remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
```

Then set the `css` option in the YAML metadata:

```yaml
output:
  xaringan::moon_reader:
    css: ["default", "ubuntu-mono.css"]
```

Here I assume `ubuntu-mono.css` is under the same directory as your Rmd.

See [yihui/xaringan#83](https://github.com/yihui/xaringan/issues/83) for an example of using the [Fira Code](https://github.com/tonsky/FiraCode) font, which supports ligatures in program code.

---

# Themes

Don't want to learn CSS? Okay, you can use some user-contributed themes. A theme typically consists of two CSS files `foo.css` and `foo-fonts.css`, where `foo` is the theme name. Below are some existing themes:

```{r}
names(xaringan:::list_css())
```

---

# Themes

To use a theme, you can specify the `css` option as an array of CSS filenames (without the `.css` extensions), e.g.,

```yaml
output:
  xaringan::moon_reader:
    css: [default, metropolis, metropolis-fonts]
```

If you want to contribute a theme to **xaringan**, please read [this blog post](https://yihui.name/en/2017/10/xaringan-themes).

---
class: inverse, middle, center
background-image: url(https://upload.wikimedia.org/wikipedia/commons/3/39/Naruto_Shiki_Fujin.svg)
background-size: contain

# Naruto

---
background-image: url(https://upload.wikimedia.org/wikipedia/commons/b/be/Sharingan_triple.svg)
background-size: 100px
background-position: 90% 8%

# Sharingan

The R package name **xaringan** was derived<sup>1</sup> from **Sharingan**, a dōjutsu in the Japanese anime _Naruto_ with two abilities:

- the "Eye of Insight"

- the "Eye of Hypnotism"

I think a presentation is basically a way to communicate insights to the audience, and a great presentation may even "hypnotize" the audience.<sup>2,3</sup>

.footnote[
[1] In Chinese, the pronounciation of _X_ is _Sh_ /ʃ/ (as in _shrimp_). Now you should have a better idea of how to pronounce my last name _Xie_.

[2] By comparison, bad presentations only put the audience to sleep.

[3] Personally I find that setting background images for slides is a killer feature of remark.js. It is an effective way to bring visual impact into your presentations.
]

---

# Naruto terminology

The **xaringan** package borrowed a few terms from Naruto, such as

- [Sharingan](http://naruto.wikia.com/wiki/Sharingan) (写輪眼; the package name)

- The [moon reader](http://naruto.wikia.com/wiki/Moon_Reader) (月読; an attractive R Markdown output format)

- [Chakra](http://naruto.wikia.com/wiki/Chakra) (查克拉; the path to the remark.js library, which is the power to drive the presentation)

- [Nature transformation](http://naruto.wikia.com/wiki/Nature_Transformation) (性質変化; transform the chakra by setting different options)

- The [infinite moon reader](http://naruto.wikia.com/wiki/Infinite_Tsukuyomi) (無限月読; start a local web server to continuously serve your slides)

- The [summoning technique](http://naruto.wikia.com/wiki/Summoning_Technique) (download remark.js from the web)

You can click the links to know more about them if you want. The jutsu "Moon Reader" may seem a little evil, but that does not mean your slides are evil.

---

class: center

# Hand seals (印)

Press `h` or `?` to see the possible ninjutsu you can use in remark.js.

![](https://upload.wikimedia.org/wikipedia/commons/7/7e/Mudra-Naruto-KageBunshin.svg)

---

class: center, middle

# Thanks!

Slides created via the R package [**xaringan**](https://github.com/yihui/xaringan).

The chakra comes from [remark.js](https://remarkjs.com), [**knitr**](http://yihui.name/knitr), and [R Markdown](https://rmarkdown.rstudio.com).
